### 定义与用途
zk是一个分布式协调服务，用于实现发布/订阅、负载均衡、命名服务、分布式协调/通知、集群管理、Master选举、分布式锁和分布式队列等功能。

### 核心概念

#### 集群
  - 角色: Leader、Follower、Observer
  - 同一时刻只会有一个Leader，通过选举过程产生。
  - Leader负载为客户端提供读写服务，其他两个只负责读
  - Follower、Observer两者的区别是，Observer不参与选举过程，也不参与写操作的"过半写成功"策略
  - 每个节点配置的配置文件（zoo.cfg）相同
  - myid文件中的值为zoo.cfg的server.x中的一个(x是一个数字)
  - 常用命令
    ```sh
    # 启动Zookeeper命令如下：
    cd /home/hadoop/apps/zookeeper-3.4.9/bin/
    ./zkServer.sh start

    # 查看状态：一个leader，两个follower，命令如下：
    ./zkServer.sh status

    ```

#### 会话Session
指的是客户端会话

- zk对外的服务端口默认为2181
- 客户端与服务端通过TCP建立长连接
- 建立连接后，客户端通过心跳检测和服务器保持会话
- 客户端可以向服务端发送请求并接受响应，也可以接收来自服务端的Watch事件通知
- 会话超时(SessionTimeout)，当出服务器压力大、网络故障、客户端主动断开等情况时，在该超时时间内能够重新连接上集群中的任意一台服务器，从而保持之前的会话。

#### 数据节点(ZNode)
一般每个节点都是一台服务器，zk中的数据节点是指数据模型中的数据单元，称为ZNode.

- zk将所以数据存储在内存中，数据模型为一颗树(ZNode Tree), 每个ZNode的路径通过`"/"`来分割。类似于目录与文件的关系。
- ZNode分为持久节点和临时节点
- 持久节点创建后需主动移除
- 临时节点和客户端会话绑定，一旦会话失效，该客户端创建的临时节点都会被移除
- 每个数据节点都可以添加SEQUENTIAL属性，那么在创建该节点时都会在节点后面自动追加一个整形数字，它是由父节点维护的自增数字

#### 版本
每个ZNode都会存储数据，zk为每个znode维护一个Stat的数据结构，记录znode的版本信息： version(当前版本）、cversion(当前子节点版本)、aversion(当前znode acl版本)

#### 事务
改变zk服务器状态操作称为事务；一般包括znode创建、删除、数据内容更新和客户端会话创建和失效操作。

- 每个事务请求都会又一个全局唯一的事务ID（ZXID，64位）；
- 通过ZXID的操作顺序可以所有事务的全局处理顺序。

#### Watcher（监听器）
在指定节点上注册Watcher, 在特定事件发生时，服务端会将事件通知到感兴趣的客户端。该机制是实现分布式协调的重要特性。

#### ACL (权限控制)
 CREATE、READ、WRITE、DELETE、ADMIN；
 CREATE 和 DELETE是针对子节点的。

 #### 典型应用场景

 - 配置中心(数据发布与订阅，推拉结合的方式)
 - 命名服务，在分布式系统中，通过命名服务，客户端可以根据名字来获取资源或服务的地址、提供者等信息。
 - 分布式协调和通知(利用watcher机制)
 - 心跳检测，利用临时节点的特性，可以判断进程是否存活。
 - Master选举